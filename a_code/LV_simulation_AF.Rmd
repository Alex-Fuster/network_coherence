---
title: "LV simulation - AF"
---

```{r}
library(deSolve)
library(faux)
library(tidyr)
library(MASS)
library(ggplot2)
library(ggpubr)
library(scales)
source(here::here("a_code/functions_LV_simulation_AF.R"))
```

```{r}
# pars for plotting:

my_theme = theme(axis.text=element_text(size=12),
                 axis.title = element_text(size = 14),
                 legend.text=element_text(size=14),
                 legend.title = element_text(size=14),
                 plot.title = element_text(face="bold",size=14,margin=margin(0,0,20,0),hjust = 0.5),
                 axis.title.y = element_text(hjust = 0.5),
                 axis.title.x = element_text(hjust = 0.5))
```



simulate species dynamics using the above parameters and a home-made function

parameters

```{r}
params <- list(
  
  # number of species
  S = 25, 
  
  # simulating interaction networks 
  Net_type = "predator-prey", # type of network: predator-prey, mutualistic, competition
  C = 0.2, # connectance 
  aij_params = c(0, 0.1), # mean and standard deviation of interaction strength
  efficiency = 0.5, # efficiency of predators to transform prey biomass 
  rho = 0, 
  
  # simulating species responses to an environmental perturbation
  NC_parms = 0, # network coherence 
  delta_r_params = c(0, 1), # mean and standard deviation of the changes in species growth rates after the perturbation (squared)
  prop_neg = 0.5, # proportion of delta r dans are negative
  
  # simulating species dynamics 
  maxt = 100 # number of time steps before and after the perturbation
)
```


Simulation

```{r}

covariance_types <- c("strong_positive_decreases","weak_positive_decreases","weak_mixed", "weak_positive_increases", "strong_positive_increases", "strong_mixed")

net_type_list <- list()
 ENC_list <- list()
# delta_biomass_list <- list()
 A_list <- list()
 C_list <- list()
 cov_type_list <- list()
# r_list <- list()
# new_r_list <- list()



df <- data.frame()
for (Net_type in c("random", "predator-prey", "mutualistic", "competition")) {
  for (cov_type in covariance_types) {
    params$Net_type <- Net_type
    for (i in 1:100) {
      out <- simulate_dynamics(params, cov_type = cov_type)
      
      NC <- calculate_enc_pattern(A_matrix = out$A, C_matrix = out$C)
      delta_biomass <- out$dyn[nrow(out$dyn), ] - out$dyn[params$maxt, ]
      extinctions <- sum(out$dyn[nrow(out$dyn), -1] < 0.01)
      
      df <- rbind(df,
                  data.frame(Net_type = Net_type, 
                             cov_type = cov_type,
                             NC_mean = mean(NC, na.rm = T), 
                             NC_sd = sd(NC, na.rm = T), 
                             delta_biom_sum = sum(delta_biomass),
                             delta_biom_sd = sd(delta_biomass), 
                             extinctions = extinctions))
      
      # ENC_list[[i]] <- NC
      # delta_biomass_list[[i]] <- delta_biomass
      # A_list[[i]] <- out$A
      # C_list[[i]] <- out$C
      # r_list[[i]] <- out$r
      # new_r_list[[i]] <- out$new_r
      
 # Store the matrices and associated information only on the last iteration (i == 100)
      if (i == 100) {
        net_type_list <- c(net_type_list, Net_type)
        cov_type_list <- c(cov_type_list, cov_type)
        ENC_list <- c(ENC_list, list(NC))
        A_list <- c(A_list, list(out$A))
        C_list <- c(C_list, list(out$C))
      }
      
      # Append to the dataframe

    }
  }
}


df_matrices <- data.frame(
  net_type = unlist(net_type_list),
  cov_type = unlist(cov_type_list),
  ENC_matrix = I(ENC_list),
  A_matrix = I(A_list),
  C_matrix = I(C_list),
  stringsAsFactors = FALSE
)

```





```{r}
 # for brewer_pal

df$cov_type <- factor(df$cov_type, 
                      levels = c("strong_positive_decreases", "weak_positive_decreases", "weak_mixed", 
                                 "weak_positive_increases", "strong_positive_increases", "strong_mixed"))

# Define the color palette for the scenarios
color_palette <- c("weak_positive_decreases" = brewer_pal(palette = "RdBu", direction = -1)(10)[8],  # Weak red
                   "strong_positive_decreases" = brewer_pal(palette = "RdBu", direction = -1)(10)[9], # Strong red
                   "weak_positive_increases" = brewer_pal(palette = "RdBu", direction = 1)(10)[8],    # Weak blue
                   "strong_positive_increases" = brewer_pal(palette = "RdBu", direction = 1)(10)[9],  # Strong blue
                   "weak_mixed" = "violet",  # Violet color
                   "strong_mixed" = "magenta4")  # Magenta4 color

# Plot 1: Mean Total Biomass Change across Scenarios
p1 <- ggplot(df, aes(x = cov_type, y = delta_biom_sum, color = cov_type)) +
  geom_jitter(alpha = 0.7, width = 0.2) +  # Jitter points instead of using boxplot
  scale_color_manual(values = color_palette) +
  labs(x = "Covariance type", 
       y = expression(paste(italic(Delta), " Total Biomass"))) +
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dashed")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  my_theme

# Plot 2: Variance in Biomass Change across Scenarios
p2 <- ggplot(df, aes(x = cov_type, y = delta_biom_sd, color = cov_type)) +
  geom_jitter(alpha = 0.7, width = 0.2) +  # Jitter points instead of using boxplot
  scale_color_manual(values = color_palette) +
  labs(x = "Covariance type", 
       y = expression(paste("SD(" ,italic(Delta), " Total Biomass)"))) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  my_theme

# Arrange the plots side by side
plot_cov_scenarios <- ggarrange(p1, 
                        p2, 
                        ncol = 2, 
                        labels = LETTERS[1:2],
                        legend = "none")


# Display the plot
plot_cov_scenarios


```

For all interaction types:

```{r}
p1 <- ggplot(df, aes(x = cov_type, y = delta_biom_sum, color = cov_type)) +
  geom_jitter(alpha = 0.7, width = 0.2) +  # Jitter points instead of using boxplot
  scale_color_manual(values = color_palette) +
  labs(x = "Covariance type", 
       y = expression(paste(italic(Delta), " Total Biomass"))) +
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dashed")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  facet_wrap(~Net_type) +
  my_theme

# Plot 2: Variance in Biomass Change across Scenarios
p2 <- ggplot(df, aes(x = cov_type, y = delta_biom_sd, color = cov_type)) +
  geom_jitter(alpha = 0.7, width = 0.2) +  # Jitter points instead of using boxplot
  scale_color_manual(values = color_palette) +
  labs(x = "Covariance type", 
       y = expression(paste("SD(" ,italic(Delta), " Total Biomass)"))) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  facet_wrap(~Net_type) +
  my_theme

# Arrange the plots side by side
plot_cov_scenarios_int <- ggarrange(p1, 
                        p2, 
                        ncol = 2, 
                        labels = LETTERS[1:2],
                        legend = "none")


# Display the plot
plot_cov_scenarios_int
```



## Plot per ENC values

```{r}
p1 <- ggplot(df) +
  geom_point(aes(NC_mean, delta_biom_sum, colour = Net_type), alpha = 0.25) +
  geom_smooth(aes(NC_mean, delta_biom_sum, colour = Net_type), se = F) +
  labs(x = "Mean ENC", y = expression(paste(italic(Delta)," total biomass")),
         colour = "Network type") +
  theme_classic()+
  my_theme


p2 <- ggplot(df) +
  geom_point(aes(NC_mean, delta_biom_sd, colour = Net_type), alpha = 0.25) +
  geom_smooth(aes(NC_mean, delta_biom_sd, colour = Net_type), se = F) +
  scale_y_continuous(trans = "log", breaks = c(0.2, 1, 5), limits = c(0.2, 10)) +
  labs(x = "Mean ENC", y = "SD in biomass", colour = "Network type") +
  theme_classic()+
  my_theme



p3 <- ggplot(df) +
  geom_point(aes(NC_sd, delta_biom_sum, colour = Net_type), alpha = 0.25) +
  geom_smooth(aes(NC_sd, delta_biom_sum, colour = Net_type), se = F) +
  labs(x = "SD ENC", y = expression(paste(italic(Delta)," total biomass")), colour = "Network type") +
  theme_classic()+
  my_theme


p4 <- ggplot(df) +
  geom_point(aes(NC_sd, delta_biom_sd, colour = Net_type), alpha = 0.25) +
  geom_smooth(aes(NC_sd, delta_biom_sd, colour = Net_type), se = F) +
  scale_y_continuous(trans = "log", breaks = c(0.2, 1, 5), limits = c(0.2, 10)) +
  labs(x = "SD ENC", y = "SD in biomass", colour = "Network type") +
  theme_classic()+
  my_theme




ggarrange(
  p1, 
  p2, 
  p3,
  p4,
  
  nrow = 2,
  ncol = 2,
  
  labels = LETTERS[1:4],
  
  common.legend = TRUE
)

#ggsave("c_outputs/figures/LVsimulations_cov_100sp.png", height = 9, width = 10)

```




```{r}
# Filter the dataframe for only predator-prey networks
df_predator_prey <- df %>% dplyr::filter(Net_type == "predator-prey")

# Plot 1: Mean Total Biomass Change vs Mean ENC
p1 <- ggplot(df_predator_prey) +
  geom_point(aes(NC_mean, delta_biom_sum, color = cov_type), alpha = 0.5) +
  geom_smooth(aes(NC_mean, delta_biom_sum), se = F, color = "black", linetype = "dashed") +
  labs(x = "Mean ENC", y = expression(paste(italic(Delta)," total biomass")), color = "cov type") +
  theme_classic() +
  scale_color_manual(values = color_palette)+
  my_theme

# Plot 2: Variance in Biomass Change vs Mean ENC
p2 <- ggplot(df_predator_prey) +
  geom_point(aes(NC_mean, delta_biom_sd, color = cov_type), alpha = 0.5) +
  geom_smooth(aes(NC_mean, delta_biom_sd), se = F, color = "black", linetype = "dashed") +
  scale_y_continuous(trans = "log", breaks = c(0.2, 1, 5), limits = c(0.2, 10)) +
  labs(x = "Mean ENC", y = "SD in biomass", color = "cov type") +
  scale_color_manual(values = color_palette)+
  theme_classic() +
  my_theme

# Plot 3: Mean Total Biomass Change vs SD ENC
p3 <- ggplot(df_predator_prey) +
  geom_point(aes(NC_sd, delta_biom_sum, color = cov_type), alpha = 0.5) +
  geom_smooth(aes(NC_sd, delta_biom_sum), se = F, color = "black", linetype = "dashed") +
  labs(x = "SD ENC", y = expression(paste(italic(Delta)," total biomass")), color = "cov type") +
  scale_color_manual(values = color_palette)+
  theme_classic() +
  my_theme

# Plot 4: Variance in Biomass Change vs SD ENC
p4 <- ggplot(df_predator_prey) +
  geom_point(aes(NC_sd, delta_biom_sd, color = cov_type), alpha = 0.5) +
  geom_smooth(aes(NC_sd, delta_biom_sd), se = F, color = "black", linetype = "dashed") +
  scale_y_continuous(trans = "log", breaks = c(0.2, 1, 5), limits = c(0.2, 10)) +
  labs(x = "SD ENC", y = "SD in biomass", color = "cov type") +
  scale_color_manual(values = color_palette)+
  theme_classic() +
  my_theme

# Arrange the plots in a 2x2 grid
final_plot <- ggarrange(
  p1, 
  p2, 
  p3,
  p4,
  
  nrow = 2,
  ncol = 2,
  
  labels = LETTERS[1:4],
  
  common.legend = TRUE
)


# Display the plot
final_plot

```


## plot C matrices examples per scenario


```{r}
# Filter the dataframe for predator-prey interactions
df_predator_prey <- df_matrices[df_matrices$net_type == "predator-prey",]



# Initialize an empty list to store the plots
plot_list <- list()

# Loop through each cov_type to generate individual plots
for (i in 1:nrow(df_predator_prey)) {
  
  # Extract the C matrix and convert to a dataframe for plotting
  C_values <- as.vector(df_predator_prey$C_matrix[[i]])
  data <- data.frame(response = C_values)
  
  # Create the plot for each covariance type
  p <- ggplot(data, aes(x = response, fill = ..x..)) +
    geom_histogram(bins = 30, alpha = 0.9) +
    scale_fill_distiller(palette = "RdBu", limits = c(-2, 2), direction = 1) +
    labs(x = "Covariance between species responses", 
         y = "Frequency", 
         title = df_predator_prey$cov_type[i]) +
    theme_classic() +
    xlim(-3, 3) +
    theme(legend.position = "none",
          plot.title = element_text(hjust = 0.5)) +
    my_theme
  
  # Add the plot to the list
  plot_list[[i]] <- p
}


ggarrange(
  
  plot_list[[1]],
  plot_list[[2]],
  plot_list[[3]],
  plot_list[[4]],
  plot_list[[5]],
  plot_list[[6]],
  
  ncol = 3,
  nrow = 2
)

```

## plot ENC matrices examples per scenario


```{r}

df_matrices$ENC_filtered <- vector("list", nrow(df_matrices))

# Loop through each row of the dataframe to filter ENC matrices based on A matrices
for (i in 1:nrow(df_matrices)) {
  
  # Extract the ENC_matrix and A_matrix for the current row
  ENC_matrix <- df_matrices$ENC_matrix[[i]]
  A_matrix <- df_matrices$A_matrix[[i]]
  
  # Filter out the ENC values corresponding to non-zero A_matrix values
  ENC_filtered <- ENC_matrix[A_matrix != 0]
  
  # Add the filtered ENC matrix to the new column
  df_matrices$ENC_filtered[[i]] <- ENC_filtered
}


df_predator_prey <- df_matrices[df_matrices$net_type == "predator-prey",]


# Initialize an empty list to store the plots
plot_list <- list()

# Loop through each cov_type to generate individual plots
for (i in 1:nrow(df_predator_prey)) {
  
  # Extract the C matrix and convert to a dataframe for plotting
  C_values <- df_predator_prey$ENC_filtered[[i]]
  data <- data.frame(response = C_values)
  
  # Create the plot for each covariance type
  p <- ggplot(data, aes(x = response, fill = ..x..)) +
    geom_histogram(bins = 30, alpha = 0.9) +
    scale_fill_distiller(palette = "RdBu", limits = c(-2, 2), direction = 1) +
    labs(x = "Covariance between species responses", 
         y = "Frequency", 
         title = df_predator_prey$cov_type[i]) +
    theme_classic() +
    xlim(-3, 3) +
    theme(legend.position = "none",
          plot.title = element_text(hjust = 0.5)) +
    my_theme
  
  # Add the plot to the list
  plot_list[[i]] <- p
}


ggarrange(
  
  plot_list[[1]],
  plot_list[[2]],
  plot_list[[3]],
  plot_list[[4]],
  plot_list[[5]],
  plot_list[[6]],
  
  ncol = 3,
  nrow = 2
)

```



## plot species dynamics

```{r}
plot_dynamic <- function(dyn){
  plot(y = dyn[,2], x = 1:nrow(dyn), type = "l", ylim = c(0, max(dyn[,c(2:ncol(dyn))])), xlab = "time", ylab = "Biomass")
  cols <- sample(1:ncol(dyn))
  for (i in 3:ncol(dyn)){
    lines(y = dyn[,i], x = 1:nrow(dyn), col = cols[i])
  }
}
plot_dynamic(out$dyn)
```



## Plot r values for one community

```{r}
plot_r_dynamics <- function(r, new_r, delta_r, community_num) {
  data <- data.frame(Species = 1:length(r), r = r, new_r = new_r, delta_r = delta_r)
  
  data_long <- data %>%
    pivot_longer(cols = c(r, new_r, delta_r), names_to = "Variable", values_to = "Value")
  
  ggplot(data_long, aes(x = Species, y = Value, color = Variable)) +
    geom_point(size = 3) +
    scale_color_manual(values = c("r" = "blue", "new_r" = "green", "delta_r" = "red")) +
    labs(title = paste("r, new_r, and delta_r for Community", community_num),
         x = "Species", y = "Value") +
    geom_hline(yintercept = 0, linetype = "dashed")+
    theme_classic() +
    my_theme
}

# Example usage:

 plot_r_dynamics(r_list[[1]], new_r_list[[1]], new_r_list[[1]] - r_list[[1]], 1)
 

```





## plot C matrix

```{r}
# Assuming `C_matrix` is your C matrix
# Convert the matrix to a dataframe for plotting the distribution
C_values <- as.vector(df_matrices$C_matrix[[1]])
data <- data.frame(response = C_values)

# Create the plot
ggplot(data, aes(x = response, fill = ..x..)) +
  geom_histogram(bins = 30, alpha = 0.7) +
  scale_fill_distiller(palette = "RdBu", limits = c(-3, 3), direction = 1) +
  labs(x = "Covariance between species responses", 
       y = "Frequency", 
       title = "Distribution of Species Response Covariances") +
  theme_classic() +
  xlim(-3, 3) +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5)) +
  my_theme


```




- all distributions have many weak covariances and small extreme values, and is pretty even. I should come up with distributions that are shifted towards positive covariances for instance, or that have both strong positive and negative and few weak covariances.



## Plot ENC

```{r}

df_matrices$ENC_filtered <- vector("list", nrow(df_matrices))

# Loop through each row of the dataframe to filter ENC matrices based on A matrices
for (i in 1:nrow(df_matrices)) {
  
  # Extract the ENC_matrix and A_matrix for the current row
  ENC_matrix <- df_matrices$ENC_matrix[[i]]
  A_matrix <- df_matrices$A_matrix[[i]]
  
  # Filter out the ENC values corresponding to non-zero A_matrix values
  ENC_filtered <- ENC_matrix[A_matrix != 0]
  
  # Add the filtered ENC matrix to the new column
  df_matrices$ENC_filtered[[i]] <- ENC_filtered
}



```

- ENC shows a much strong pattern of many 0 covariance or very weak, and very few strong. 